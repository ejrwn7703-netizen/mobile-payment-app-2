<!doctype html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ë°”ì½”ë“œ ìŠ¤ìº” - ë¬´ì¸ê³„ì‚°ì•±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px 20px;
        }

        .scan-section {
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .result-card {
            display: none;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #667eea;
        }

        .result-card.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .result-card.error {
            border-left-color: #dc3545;
            background: #fee;
        }

        .result-card.error small {
            display: block;
            margin-top: 8px;
            opacity: 0.9;
        }

        .result-card.success {
            border-left-color: #28a745;
            background: #e7f9ed;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .product-info {
            display: grid;
            gap: 12px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #666;
        }

        .info-value {
            color: #333;
            font-weight: 500;
        }

        .price {
            font-size: 24px;
            color: #667eea;
            font-weight: 700;
        }

        .cart-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #e0e0e0;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .cart-item-price {
            color: #667eea;
            font-weight: 500;
        }

        .cart-item-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .qty-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            background: #667eea;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .qty-btn:hover {
            background: #5568d3;
            transform: scale(1.1);
        }

        .qty-display {
            min-width: 30px;
            text-align: center;
            font-weight: 600;
        }

        .cart-total {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }

        .cart-total-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .cart-total-amount {
            font-size: 32px;
            font-weight: 700;
        }

        .empty-cart {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        #reader {
            border: 2px solid #667eea;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .mode-switch {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #667eea;
            border-radius: 10px;
            background: white;
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .mode-btn:hover:not(.active) {
            background: #f0f0f0;
        }

        .camera-section {
            display: none;
        }

        .camera-section.active {
            display: block;
        }

        .manual-section {
            display: none;
        }

        .manual-section.active {
            display: block;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ›’ ë°”ì½”ë“œ ìŠ¤ìº”</h1>
            <p>ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì—¬ ìƒí’ˆì„ ì¥ë°”êµ¬ë‹ˆì— ë‹´ìœ¼ì„¸ìš”</p>
        </div>

        <div class="content">
            <div class="scan-section">
                <!-- ëª¨ë“œ ì„ íƒ ë²„íŠ¼ -->
                <div class="mode-switch">
                    <button class="mode-btn active" onclick="switchMode('camera')">
                        ğŸ“· ì¹´ë©”ë¼ ìŠ¤ìº”
                    </button>
                    <button class="mode-btn" onclick="switchMode('manual')">
                        âŒ¨ï¸ ìˆ˜ë™ ì…ë ¥
                    </button>
                </div>

                <!-- ì¹´ë©”ë¼ ìŠ¤ìº” ì„¹ì…˜ -->
                <div id="cameraSection" class="camera-section active">
                    <div
                        style="margin-bottom: 10px; padding: 10px; background: #fff3cd; border-radius: 8px; font-size: 13px; color: #856404;">
                        ğŸ’¡ ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”. ë°”ì½”ë“œë¥¼ ì¹´ë©”ë¼ì— ë¹„ì¶”ë©´ ìë™ìœ¼ë¡œ ì¸ì‹ë©ë‹ˆë‹¤.
                    </div>
                    <div id="reader"></div>
                    <button class="btn btn-secondary" onclick="stopCamera()">
                        â¹ï¸ ì¹´ë©”ë¼ ì¤‘ì§€
                    </button>
                </div>

                <!-- ìˆ˜ë™ ì…ë ¥ ì„¹ì…˜ -->
                <div id="manualSection" class="manual-section">
                    <div class="input-group">
                        <label for="barcode">ë°”ì½”ë“œ ë²ˆí˜¸ (8-13ìë¦¬)</label>
                        <input type="text" id="barcode" placeholder="8801234567890" pattern="[0-9]*"
                            inputmode="numeric" />
                    </div>

                    <button class="btn btn-primary" onclick="scanBarcode()">
                        ğŸ” ìŠ¤ìº”í•˜ê¸°
                    </button>

                    <button class="btn btn-secondary" onclick="showSamples()">
                        ğŸ’¡ ìƒ˜í”Œ ë°”ì½”ë“œ ë³´ê¸°
                    </button>
                </div>

                <div id="scanResult" class="result-card"></div>
            </div>

            <div class="cart-section">
                <h2 style="margin-bottom: 20px; color: #333;">ğŸ›ï¸ ì¥ë°”êµ¬ë‹ˆ</h2>
                <div id="cartItems"></div>
                <div id="cartTotal"></div>
                <button class="btn btn-primary" onclick="goToCheckout()" style="margin-top: 20px;">
                    ğŸ’³ ê²°ì œí•˜ê¸°
                </button>
            </div>
        </div>
    </div>

    <!-- html5-qrcode ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <script>
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let html5QrCode = null;
        let isScanning = false;
        let currentMode = 'camera';

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¥ë°”êµ¬ë‹ˆ í‘œì‹œ ë° ì¹´ë©”ë¼ ì‹œì‘
        updateCartDisplay();

        // í˜ì´ì§€ ë¡œë“œ í›„ ì¹´ë©”ë¼ ì‹œì‘ (ì•½ê°„ì˜ ì§€ì—°)
        setTimeout(() => {
            if (currentMode === 'camera') {
                startCamera();
            }
        }, 500);

        // Enter í‚¤ë¡œ ìŠ¤ìº” (ìˆ˜ë™ ì…ë ¥ ëª¨ë“œ)
        document.getElementById('barcode').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                scanBarcode();
            }
        });

        // ëª¨ë“œ ì „í™˜
        function switchMode(mode) {
            currentMode = mode;

            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë³€ê²½
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // í´ë¦­ëœ ë²„íŠ¼ì— active ì¶”ê°€
            if (mode === 'camera') {
                document.querySelectorAll('.mode-btn')[0].classList.add('active');
            } else {
                document.querySelectorAll('.mode-btn')[1].classList.add('active');
            }

            // ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¹€
            if (mode === 'camera') {
                document.getElementById('cameraSection').classList.add('active');
                document.getElementById('manualSection').classList.remove('active');
                startCamera();
            } else {
                document.getElementById('cameraSection').classList.remove('active');
                document.getElementById('manualSection').classList.add('active');
                stopCamera();
                document.getElementById('barcode').focus();
            }
        }

        // ì¹´ë©”ë¼ ì‹œì‘
        async function startCamera() {
            if (isScanning) {
                console.log("ì¹´ë©”ë¼ê°€ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.");
                return;
            }

            try {
                // ê¸°ì¡´ ì¸ìŠ¤í„´ìŠ¤ê°€ ìˆìœ¼ë©´ ì •ë¦¬
                if (html5QrCode) {
                    try {
                        await html5QrCode.stop();
                    } catch (e) {
                        console.log("ê¸°ì¡´ ì¹´ë©”ë¼ ì¤‘ì§€ ì¤‘ ì—ëŸ¬ ë¬´ì‹œ:", e);
                    }
                    html5QrCode = null;
                }

                html5QrCode = new Html5Qrcode("reader");

                const config = {
                    fps: 10,
                    qrbox: { width: 250, height: 250 },
                    aspectRatio: 1.0,
                    formatsToSupport: [
                        Html5QrcodeSupportedFormats.EAN_13,
                        Html5QrcodeSupportedFormats.EAN_8,
                        Html5QrcodeSupportedFormats.CODE_128,
                        Html5QrcodeSupportedFormats.QR_CODE
                    ]
                };

                // ë¨¼ì € ì‚¬ìš© ê°€ëŠ¥í•œ ì¹´ë©”ë¼ ëª©ë¡ í™•ì¸
                const cameras = await Html5Qrcode.getCameras();

                if (!cameras || cameras.length === 0) {
                    throw new Error("ì‚¬ìš© ê°€ëŠ¥í•œ ì¹´ë©”ë¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
                }

                console.log(`${cameras.length}ê°œì˜ ì¹´ë©”ë¼ ë°œê²¬:`, cameras);

                // ì¹´ë©”ë¼ ì‹œì‘ ì‹œë„
                let cameraStarted = false;
                let lastError = null;

                // ë°©ë²• 1: í™˜ê²½ ì¹´ë©”ë¼ (í›„ë©´ ì¹´ë©”ë¼)
                if (!cameraStarted) {
                    try {
                        await html5QrCode.start(
                            { facingMode: "environment" },
                            config,
                            onScanSuccess,
                            onScanError
                        );
                        cameraStarted = true;
                        console.log("í™˜ê²½ ì¹´ë©”ë¼(í›„ë©´) ì‹œì‘ ì„±ê³µ");
                    } catch (err) {
                        lastError = err;
                        console.log("í™˜ê²½ ì¹´ë©”ë¼ ì‹¤íŒ¨, ë‹¤ìŒ ì‹œë„...");
                    }
                }

                // ë°©ë²• 2: ì‚¬ìš©ì ì¹´ë©”ë¼ (ì „ë©´ ì¹´ë©”ë¼)
                if (!cameraStarted) {
                    try {
                        await html5QrCode.start(
                            { facingMode: "user" },
                            config,
                            onScanSuccess,
                            onScanError
                        );
                        cameraStarted = true;
                        console.log("ì‚¬ìš©ì ì¹´ë©”ë¼(ì „ë©´) ì‹œì‘ ì„±ê³µ");
                    } catch (err) {
                        lastError = err;
                        console.log("ì‚¬ìš©ì ì¹´ë©”ë¼ ì‹¤íŒ¨, ë‹¤ìŒ ì‹œë„...");
                    }
                }

                // ë°©ë²• 3: ì²« ë²ˆì§¸ ì¹´ë©”ë¼ ID ì‚¬ìš©
                if (!cameraStarted && cameras.length > 0) {
                    try {
                        await html5QrCode.start(
                            cameras[0].id,
                            config,
                            onScanSuccess,
                            onScanError
                        );
                        cameraStarted = true;
                        console.log("ì²« ë²ˆì§¸ ì¹´ë©”ë¼ë¡œ ì‹œì‘ ì„±ê³µ");
                    } catch (err) {
                        lastError = err;
                        console.log("ì²« ë²ˆì§¸ ì¹´ë©”ë¼ ì‹¤íŒ¨");
                    }
                }

                if (cameraStarted) {
                    isScanning = true;
                    showResult('success', 'ì¹´ë©”ë¼ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ë°”ì½”ë“œë¥¼ ë¹„ì¶°ì£¼ì„¸ìš”.');
                } else {
                    throw lastError || new Error("ëª¨ë“  ì¹´ë©”ë¼ ì‹œì‘ ì‹œë„ ì‹¤íŒ¨");
                }

            } catch (err) {
                console.error("ì¹´ë©”ë¼ ì‹œì‘ ì‹¤íŒ¨:", err);
                isScanning = false;
                html5QrCode = null;

                let errorMsg = 'ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ';
                let errorDetail = '';

                if (err.name === 'NotAllowedError' || err.message?.includes('Permission')) {
                    errorMsg = 'âŒ ì¹´ë©”ë¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.';
                    errorDetail = 'ë¸Œë¼ìš°ì € ì£¼ì†Œì°½ì˜ ì¹´ë©”ë¼ ì•„ì´ì½˜ì„ í´ë¦­í•˜ì—¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
                } else if (err.name === 'NotFoundError') {
                    errorMsg = 'âŒ ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                    errorDetail = 'ì¹´ë©”ë¼ê°€ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.';
                } else if (err.name === 'NotReadableError' || err.message?.includes('in use')) {
                    errorMsg = 'âŒ ì¹´ë©”ë¼ê°€ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.';
                    errorDetail = 'ë‹¤ë¥¸ ì•±(Zoom, Teams, Skype ë“±)ì—ì„œ ì¹´ë©”ë¼ë¥¼ ì‚¬ìš© ì¤‘ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•´ë‹¹ ì•±ì„ ì¢…ë£Œí•˜ê³  ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜, ìˆ˜ë™ ì…ë ¥ ëª¨ë“œë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.';
                } else {
                    errorMsg = 'âŒ ì¹´ë©”ë¼ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                    errorDetail = 'ìˆ˜ë™ ì…ë ¥ ëª¨ë“œë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.';
                }

                showResult('error', errorMsg + '<br><small style="font-size: 12px;">' + errorDetail + '</small>');

                // 2ì´ˆ í›„ ìë™ìœ¼ë¡œ ìˆ˜ë™ ì…ë ¥ ëª¨ë“œë¡œ ì „í™˜
                setTimeout(() => {
                    currentMode = 'manual';
                    document.getElementById('cameraSection').classList.remove('active');
                    document.getElementById('manualSection').classList.add('active');
                    document.querySelectorAll('.mode-btn')[0].classList.remove('active');
                    document.querySelectorAll('.mode-btn')[1].classList.add('active');
                    document.getElementById('barcode').focus();
                }, 3000);
            }
        }

        // ì¹´ë©”ë¼ ì¤‘ì§€
        async function stopCamera() {
            if (html5QrCode && isScanning) {
                try {
                    await html5QrCode.stop();
                    isScanning = false;
                    html5QrCode = null;
                    console.log("ì¹´ë©”ë¼ ì¤‘ì§€ ì„±ê³µ");
                } catch (err) {
                    console.error("ì¹´ë©”ë¼ ì¤‘ì§€ ì‹¤íŒ¨:", err);
                    // ê°•ì œë¡œ ìƒíƒœ ì´ˆê¸°í™”
                    isScanning = false;
                    html5QrCode = null;
                }
            }
        }

        // ìŠ¤ìº” ì„±ê³µ ì½œë°±
        async function onScanSuccess(decodedText, decodedResult) {
            console.log("ë°”ì½”ë“œ ìŠ¤ìº” ì„±ê³µ:", decodedText);

            // ì¤‘ë³µ ìŠ¤ìº” ë°©ì§€ (1ì´ˆ ì¿¨íƒ€ì„)
            if (!window.lastScanTime || Date.now() - window.lastScanTime > 1000) {
                window.lastScanTime = Date.now();
                await processBarcode(decodedText);
            }
        }

        // ìŠ¤ìº” ì—ëŸ¬ ì½œë°± (ë¬´ì‹œ)
        function onScanError(errorMessage) {
            // ì—ëŸ¬ëŠ” ë¬´ì‹œ (ì§€ì†ì ìœ¼ë¡œ ìŠ¤ìº” ì‹œë„)
        }

        // ë°”ì½”ë“œ ì²˜ë¦¬ (ì¹´ë©”ë¼/ìˆ˜ë™ ì…ë ¥ ê³µí†µ)
        async function processBarcode(barcode) {
            barcode = barcode.trim();

            if (!barcode) {
                showResult('error', 'ë°”ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch('/api/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ barcode })
                });

                const data = await response.json();

                if (data.success) {
                    addToCart(data.product);
                    showProductInfo(data.product);

                    // ìˆ˜ë™ ì…ë ¥ ëª¨ë“œì¼ ê²½ìš° ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                    if (currentMode === 'manual') {
                        document.getElementById('barcode').value = '';
                        document.getElementById('barcode').focus();
                    }
                } else {
                    showResult('error', data.message || 'ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                showResult('error', 'ìŠ¤ìº” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ìˆ˜ë™ ì…ë ¥ ìŠ¤ìº” (ê¸°ì¡´ í•¨ìˆ˜)
        async function scanBarcode() {
            const barcode = document.getElementById('barcode').value;
            await processBarcode(barcode);
        }

        function showProductInfo(product) {
            const resultDiv = document.getElementById('scanResult');
            resultDiv.className = 'result-card success show';
            resultDiv.innerHTML = `
                <h3 style="margin-bottom: 15px; color: #28a745;">âœ… ìƒí’ˆ ìŠ¤ìº” ì„±ê³µ!</h3>
                <div class="product-info">
                    <div class="info-row">
                        <span class="info-label">ìƒí’ˆëª…</span>
                        <span class="info-value">${product.name}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ê°€ê²©</span>
                        <span class="price">${product.price.toLocaleString()}ì›</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ì¹´í…Œê³ ë¦¬</span>
                        <span class="info-value">${product.category}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ì¬ê³ </span>
                        <span class="info-value">${product.stock}ê°œ</span>
                    </div>
                </div>
            `;
        }

        function showResult(type, message) {
            const resultDiv = document.getElementById('scanResult');
            resultDiv.className = `result-card ${type} show`;
            resultDiv.innerHTML = `
                <strong>${type === 'error' ? 'âŒ' : 'âœ…'} ${message}</strong>
            `;
        }

        function addToCart(product) {
            const existingItem = cart.find(item => item.barcode === product.barcode);

            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    ...product,
                    quantity: 1
                });
            }

            saveCart();
            updateCartDisplay();
        }

        function updateQuantity(barcode, delta) {
            const item = cart.find(i => i.barcode === barcode);
            if (item) {
                item.quantity += delta;
                if (item.quantity <= 0) {
                    cart = cart.filter(i => i.barcode !== barcode);
                }
                saveCart();
                updateCartDisplay();
            }
        }

        function saveCart() {
            localStorage.setItem('cart', JSON.stringify(cart));
        }

        function updateCartDisplay() {
            const cartItemsDiv = document.getElementById('cartItems');
            const cartTotalDiv = document.getElementById('cartTotal');

            if (cart.length === 0) {
                cartItemsDiv.innerHTML = '<div class="empty-cart">ğŸ›’ ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤</div>';
                cartTotalDiv.innerHTML = '';
                return;
            }

            cartItemsDiv.innerHTML = cart.map(item => `
                <div class="cart-item">
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-price">${item.price.toLocaleString()}ì›</div>
                    </div>
                    <div class="cart-item-actions">
                        <button class="qty-btn" onclick="updateQuantity('${item.barcode}', -1)">-</button>
                        <span class="qty-display">${item.quantity}</span>
                        <button class="qty-btn" onclick="updateQuantity('${item.barcode}', 1)">+</button>
                    </div>
                </div>
            `).join('');

            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            cartTotalDiv.innerHTML = `
                <div class="cart-total">
                    <div class="cart-total-label">ì´ ê²°ì œê¸ˆì•¡</div>
                    <div class="cart-total-amount">${total.toLocaleString()}ì›</div>
                    <div style="margin-top: 10px; font-size: 14px; opacity: 0.9;">
                        (${cart.length}ê°œ ìƒí’ˆ, ì´ ${cart.reduce((sum, i) => sum + i.quantity, 0)}ê°œ)
                    </div>
                </div>
            `;
        }

        function goToCheckout() {
            if (cart.length === 0) {
                alert('ì¥ë°”êµ¬ë‹ˆì— ìƒí’ˆì„ ë‹´ì•„ì£¼ì„¸ìš”.');
                return;
            }

            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            // ê²°ì œ í˜ì´ì§€ë¡œ ì´ë™ (checkout.htmlì— ì¥ë°”êµ¬ë‹ˆ ì •ë³´ ì „ë‹¬)
            window.location.href = `/checkout?amount=${total}&items=${cart.length}`;
        }

        function showSamples() {
            alert('ìƒ˜í”Œ ë°”ì½”ë“œ:\n\n' +
                '8801234567890 - ì‚¼ë‹¤ìˆ˜ 2L (1,500ì›)\n' +
                '8809012345678 - ì‹ ë¼ë©´ 5ê°œì… (4,500ì›)\n' +
                '8801099876543 - ì„œìš¸ìš°ìœ  1L (3,200ì›)\n' +
                '8802345678901 - í—ˆë‹ˆë²„í„°ì¹© (2,500ì›)');
        }

        // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì¹´ë©”ë¼ ì •ë¦¬
        window.addEventListener('beforeunload', () => {
            stopCamera();
        });
    </script>
</body>

</html>